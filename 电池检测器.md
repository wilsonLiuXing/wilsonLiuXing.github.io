# 电池检测器

<font color="red">MissionPlanner\GCSViews\ConfigurationView\ConfigBatteryMonitoring.cs</font>

## 初始化

<details>
<summary>点击查看代码</summary>

```csharp
public void Activate()
{
    if (!MainV2.comPort.BaseStream.IsOpen || !MainV2.comPort.MAV.param.ContainsKey("BATT_MONITOR"))
    {
        Enabled = false;
        return;
    }

    startup = true;

    CMB_batmontype.setup(
        ParameterMetaDataRepository.GetParameterOptionsInt("BATT_MONITOR",

    if (MainV2.comPort.MAV.param["BATT_CAPACITY"] != null)
        TXT_battcapacity.Text = MainV2.comPort.MAV.param["BATT_CAPACITY"].ToString();

    TXT_voltage.Text = MainV2.comPort.MAV.cs.battery_voltage.ToString();
    TXT_measuredvoltage.Text = TXT_voltage.Text;

    if (MainV2.comPort.MAV.param["BATT_AMP_PERVLT"] != null)
        TXT_AMP_PERVLT.Text = MainV2.comPort.MAV.param["BATT_AMP_PERVLT"].ToString();
    // new
    if (MainV2.comPort.MAV.param["BATT_VOLT_MULT"] != null)
        TXT_divider_VOLT_MULT.Text = MainV2.comPort.MAV.param["BATT_VOLT_MULT"].ToString();

    if (MainV2.comPort.MAV.param["BATT_AMP_PERVOLT"] != null)
        TXT_AMP_PERVLT.Text = MainV2.comPort.MAV.param["BATT_AMP_PERVOLT"].ToString();
    // old
    if (MainV2.comPort.MAV.param["VOLT_DIVIDER"] != null)
        TXT_divider_VOLT_MULT.Text = MainV2.comPort.MAV.param["VOLT_DIVIDER"].ToString();

    if (MainV2.comPort.MAV.param["AMP_PER_VOLT"] != null)
        TXT_AMP_PERVLT.Text = MainV2.comPort.MAV.param["AMP_PER_VOLT"].ToString();

    if (Settings.Instance.GetBoolean("speechbatteryenabled") && Settings.Instance.GetBoolean("speechenable"))
    {
        CHK_speechbattery.Checked = true;
    }
    else
    {
        CHK_speechbattery.Checked = false;
    }

    timer1.Start();
}
```

</details>

## 监控器

<details>
<summary>点击查看代码</summary>

```csharp
this.CMB_batmontype.DropDownStyle = System.Windows.Forms.ComboBoxStyle.DropDownList;
this.CMB_batmontype.DropDownWidth = 200;
resources.ApplyResources(this.CMB_batmontype, "CMB_batmontype");
this.CMB_batmontype.FormattingEnabled = true;
this.CMB_batmontype.Items.AddRange(new object[] {
    resources.GetString("CMB_batmontype.Items"),
    resources.GetString("CMB_batmontype.Items1"),
    resources.GetString("CMB_batmontype.Items2")
});
this.CMB_batmontype.Name = "CMB_batmontype";
this.CMB_batmontype.ParamName = null;
this.CMB_batmontype.SubControl = null;
this.CMB_batmontype.SelectedIndexChanged += new System.EventHandler(this.CMB_batmontype_SelectedIndexChanged);
/*  <data name="CMB_batmontype.Items" xml:space="preserve">
    <value>0: Disabled</value>
  </data>*/
// CMB_batmontype_SelectedIndexChanged
private void CMB_batmontype_SelectedIndexChanged(object sender, EventArgs e)
{
    // ...existing code...
}
```

</details>

## 传感器

<details>
<summary>点击查看代码</summary>

```csharp
this.CMB_batmonsensortype.DropDownWidth = 200;
this.CMB_batmonsensortype.FormattingEnabled = true;
this.CMB_batmonsensortype.Items.AddRange(new object[] {
    resources.GetString("CMB_batmonsensortype.Items"),
    resources.GetString("CMB_batmonsensortype.Items1"),
    resources.GetString("CMB_batmonsensortype.Items2"),
    resources.GetString("CMB_batmonsensortype.Items3"),
    resources.GetString("CMB_batmonsensortype.Items4"),
    resources.GetString("CMB_batmonsensortype.Items5"),
    resources.GetString("CMB_batmonsensortype.Items6"),
    resources.GetString("CMB_batmonsensortype.Items7"),
    resources.GetString("CMB_batmonsensortype.Items8"),
    resources.GetString("CMB_batmonsensortype.Items9")
});
resources.ApplyResources(this.CMB_batmonsensortype, "CMB_batmonsensortype");
this.CMB_batmonsensortype.Name = "CMB_batmonsensortype";
this.CMB_batmonsensortype.SelectedIndexChanged += new System.EventHandler(this.CMB_batmonsensortype_SelectedIndexChanged);

// CMB_batmonsensortype_SelectedIndexChanged
private void CMB_batmonsensortype_SelectedIndexChanged(object sender, EventArgs e)
{
    var selection = int.Parse(CMB_batmonsensortype.Text.Substring(0, 1));
    // ...existing code...
}
```

</details>

### 下拉项

```xml
<data name="CMB_batmonsensortype.Items" xml:space="preserve">
  <value>0: Other</value>
</data>
<data name="CMB_batmonsensortype.Items1" xml:space="preserve">
  <value>1: AttoPilot 45A</value>
</data>
<data name="CMB_batmonsensortype.Items2" xml:space="preserve">
  <value>2: AttoPilot 90A</value>
</data>
<data name="CMB_batmonsensortype.Items3" xml:space="preserve">
  <value>3: AttoPilot 180A</value>
</data>
<data name="CMB_batmonsensortype.Items4" xml:space="preserve">
  <value>4: 3DR Power Module</value>
</data>
<data name="CMB_batmonsensortype.Items5" xml:space="preserve">
  <value>5: 3DR 4 in 1 ESC</value>
</data>
<data name="CMB_batmonsensortype.Items6" xml:space="preserve">
  <value>6: 3DR HV Power Module APM</value>
</data>
<data name="CMB_batmonsensortype.Items7" xml:space="preserve">
  <value>7: Cube HV Power Module</value>
</data>
<data name="CMB_batmonsensortype.Items8" xml:space="preserve">
  <value>8: CUAV HV PM</value>
</data>
<data name="CMB_batmonsensortype.Items9" xml:space="preserve">
  <value>9: Holybro Power Module</value>
</data>
```

## 电池容量

```csharp
resources.ApplyResources(this.TXT_battcapacity, "TXT_battcapacity");
```

## APM 版本

<details>
<summary>点击查看代码</summary>

```csharp
this.CMB_HWVersion.DropDownWidth = 200;
private void CMB_apmversion_SelectedIndexChanged(object sender, EventArgs e)
{
    if (startup)
    {
        // ...existing code...
    }
}
```

</details>

## 测量电池电压

<details>
<summary>点击查看代码</summary>

```csharp
resources.ApplyResources(this.TXT_measuredvoltage, "TXT_measuredvoltage");
```

</details>

## 电池电压（计算过）

```csharp
resources.ApplyResources(this.TXT_voltage, "TXT_voltage");
this.timer1.Interval = 1000;
this.timer1.Tick += new System.EventHandler(this.timer1_Tick);
private void timer1_Tick(object sender, EventArgs e)
{
    // ...existing code...
}
```

## 电压分压器（计算过）

```csharp
resources.ApplyResources(this.TXT_divider_VOLT_MULT, "TXT_divider_VOLT_MULT");
this.TXT_divider_VOLT_MULT.Name = "TXT_divider_VOLT_MULT";
this.TXT_divider_VOLT_MULT.PreviewKeyDown += new System.Windows.Forms.PreviewKeyDownEventHandler(this.TXT_divider_PreviewKeyDown);
this.TXT_divider_VOLT_MULT.Validated += new System.EventHandler(this.TXT_divider_Validated);

// TXT_divider_PreviewKeyDown
private void TXT_divider_PreviewKeyDown(object sender, PreviewKeyDownEventArgs e)
{
    if (e.KeyData == Keys.Enter)
    {
        // ...existing code...
    }
}

// TXT_divider_Validated
private void TXT_divider_Validated(object sender, EventArgs e)
{
    if (startup || ((TextBox)sender).Enabled == false)
    {
        // ...existing code...
    }
}
```

## 测量电流

<details>
<summary>点击查看代码</summary>

```csharp
resources.ApplyResources(this.txt_meascurrent, "txt_meascurrent");
this.txt_meascurrent.Name = "txt_meascurrent";
this.txt_meascurrent.Validated += new System.EventHandler(this.txt_meascurrent_Validated);

// txt_meascurrent_Validated
private void txt_meascurrent_Validated(object sender, EventArgs e)
{
    // ...existing code...
}
```

</details>

## 电流（计算过）

```csharp
resources.ApplyResources(this.txt_current, "txt_current");
this.txt_current.ReadOnly = true;
this.timer1.Interval = 1000;
this.timer1.Tick += new System.EventHandler(this.timer1_Tick);
```

## 安培每伏

```csharp
resources.ApplyResources(this.TXT_AMP_PERVLT, "TXT_AMP_PERVLT");
this.TXT_AMP_PERVLT.Name = "TXT_AMP_PERVLT";
this.TXT_AMP_PERVLT.PreviewKeyDown += new System.Windows.Forms.PreviewKeyDownEventHandler(this.TXT_ampspervolt_PreviewKeyDown);
this.TXT_AMP_PERVLT.Validated += new System.EventHandler(this.TXT_ampspervolt_Validated);

// TXT_ampspervolt_PreviewKeyDown
private void TXT_ampspervolt_PreviewKeyDown(object sender, PreviewKeyDownEventArgs e)
{
    // ...existing code...
}

// TXT_ampspervolt_Validated
private void TXT_ampspervolt_Validated(object sender, EventArgs e)
{
    if (startup || ((TextBox)sender).Enabled == false)
    {
        // ...existing code...
    }
}
```

## 低电量时 MP 警告

```csharp
resources.ApplyResources(this.CHK_speechbattery, "CHK_speechbattery");
private void CHK_speechbattery_CheckedChanged(object sender, EventArgs e)
{
    if (startup)
    {
        // ...existing code...
    }
}
```